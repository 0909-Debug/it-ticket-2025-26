<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IT Ticket & Monthly ATR</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { margin-top: 30px; }
        label { display: block; margin-top: 10px; }
        input, select, textarea { width: 300px; max-width: 100%; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
        th { background: #f0f0f0; }
        .btn { padding: 6px 12px; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; border: none; }
        .btn-small { font-size: 11px; padding: 3px 6px; }
    </style>
</head>
<body>

<h1>Daily IT Ticket & Monthly ATR</h1>

<!-- Daily Ticket Form -->
<h2>Create Daily Ticket</h2>
<form id="ticketForm">
    <label>
        Date:
        <input type="date" id="ticketDate" required>
    </label>

    <label>
        Site:
        <input type="text" id="ticketSite" placeholder="Site name / code" required>
    </label>

    <label>
        Category:
        <select id="ticketCategory">
            <option value="Network">Network</option>
            <option value="Hardware">Hardware</option>
            <option value="Software">Software</option>
            <option value="User Access">User Access</option>
            <option value="Other">Other</option>
        </select>
    </label>

    <label>
        Issue Details:
        <textarea id="ticketIssue" rows="3" required></textarea>
    </label>

    <label>
        Action Taken:
        <textarea id="ticketAction" rows="3"></textarea>
    </label>

    <label>
        Status:
        <select id="ticketStatus">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Closed">Closed</option>
        </select>
    </label>

    <button type="submit" class="btn btn-primary">Save Ticket</button>
</form>

<!-- Daily Tickets List -->
<h2>Today / Recent Tickets</h2>
<table id="ticketsTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Site</th>
            <th>Category</th>
            <th>Issue</th>
            <th>Action Taken</th>
            <th>Status</th>
            <th>Update</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="ticketsBody"></tbody>
</table>

<!-- Export Daily Tickets -->
<button onclick="exportTableToExcel('ticketsTable', 'Daily_Tickets')">Export Daily Tickets to Excel</button>

<!-- Monthly ATR -->
<h2>Monthly ATR</h2>
<label>
    Month:
    <input type="month" id="atrMonth">
</label>

<label>
    Site (blank = all):
    <input type="text" id="atrSite" placeholder="Site name / code">
</label>

<button class="btn btn-primary" id="btnGenerateAtr">Generate ATR</button>

<table id="atrTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Site</th>
            <th>Category</th>
            <th>Issue</th>
            <th>Action Taken</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="atrBody"></tbody>
</table>

<!-- Export Monthly ATR -->
<button onclick="exportTableToExcel('atrTable', 'Monthly_ATR')">Export Monthly ATR to Excel</button>

<script>
    const STORAGE_KEY = 'itTickets_v1';

    function loadTickets() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    }

    function saveTickets(tickets) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
    }

    function renderTickets() {
        const tickets = loadTickets();
        const tbody = document.getElementById('ticketsBody');
        tbody.innerHTML = '';

        tickets.sort((a, b) => b.date.localeCompare(a.date));

        tickets.forEach(ticket => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ticket.date}</td>
                <td>${ticket.site}</td>
                <td>${ticket.category}</td>
                <td>${ticket.issue}</td>
                <td>${ticket.action}</td>
                <td>${ticket.status}</td>
                <td><button class="btn btn-small" data-id="${ticket.id}" data-action="edit">Edit</button></td>
                <td><button class="btn btn-small" data-id="${ticket.id}" data-action="delete">Delete</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    document.getElementById('ticketForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const date = document.getElementById('ticketDate').value;
        const site = document.getElementById('ticketSite').value.trim();
        const category = document.getElementById('ticketCategory').value;
        const issue = document.getElementById('ticketIssue').value.trim();
        const action = document.getElementById('ticketAction').value.trim();
        const status = document.getElementById('ticketStatus').value;

        if (!date || !site || !issue) {
            alert('Date, Site and Issue are mandatory.');
            return;
        }

        const tickets = loadTickets();
        const editingId = ticketForm.getAttribute('data-edit-id');

        if (editingId) {
            const idx = tickets.findIndex(t => t.id === editingId);
            if (idx !== -1) {
                tickets[idx] = { id: editingId, date, site, category, issue, action, status };
            }
            ticketForm.removeAttribute('data-edit-id');
        } else {
            const id = 'T' + Date.now();
            tickets.push({ id, date, site, category, issue, action, status });
        }

        saveTickets(tickets);
        renderTickets();
        ticketForm.reset();
    });

    document.getElementById('ticketsTable').addEventListener('click', function (e) {
        const btn = e.target;
        if (btn.tagName.toLowerCase() !== 'button') return;

        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const tickets = loadTickets();

        if (action === 'delete') {
            const filtered = tickets.filter(t => t.id !== id);
            saveTickets(filtered);
            renderTickets();
        }

        if (action === 'edit') {
            const ticket = tickets.find(t => t.id === id);
            if (ticket) {
                document.getElementById('ticketDate').value = ticket.date;
                document.getElementById('ticketSite').value = ticket.site;
                document.getElementById('ticketCategory').value = ticket.category;
                document.getElementById('ticketIssue').value = ticket.issue;
                document.getElementById('ticketAction').value = ticket.action;
                document.getElementById('ticketStatus').value = ticket.status;
                ticketForm.setAttribute('data-edit-id', ticket.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
    });

    document.getElementById('btnGenerateAtr').addEventListener('click', function () {
        const monthValue = document.getElementById('atrMonth').value;
        const siteFilter = document.getElementById('atrSite').value.trim().toLowerCase();
        const tbody = document.getElementById('atrBody');
        tbody.innerHTML = '';

        if (!monthValue) {
            alert('Please select a month.');
            return;
        }

        const tickets = loadTickets();

        const filtered = tickets.filter(t => {
            const ticketMonth = t.date.slice(0, 7);
            const monthMatch = (ticketMonth === monthValue);
            const siteMatch = siteFilter ? t.site.toLowerCase().includes(siteFilter) : true;
            return monthMatch && siteMatch;
        });

        filtered.sort((a, b) => a.date.localeCompare(b.date));

        filtered.forEach(ticket => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ticket.date}</td>
                <td>${ticket.site}</td>
                <td>${ticket.category}</td>
                <td>${ticket.issue}</td>
                <td>${ticket.action}</td>
                <td>${ticket.status}</td>
            `;
            tbody.appendChild(tr);
        });

        if (filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6">No tickets for selected month / site.</td>`;
            tbody.appendChild(tr);
        }
    });

    function exportTableToExcel(tableID, filename = '') {
        var downloadLink;
        var dataType = 'application/vnd.ms-excel';
        var tableSelect = document.getElementById(tableID);
        var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

        filename = filename ? filename + '.xls' : 'excel_data.xls';

        downloadLink = document.createElement("a");
        document.body.appendChild(downloadLink);

        if (navigator.msSaveOrOpenBlob) {
            var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
            downloadLink.download = filename;
            downloadLink.click();
        }
    }

    (function initDefaults() {
        const today = new Date().toISOString().slice(0, 10);
        document.getElementById('ticketDate').value = today;
        document.getElementById('atrMonth').value = today.slice(0, 7);
        renderTickets();
    })();
</script>

</body>
</html>
